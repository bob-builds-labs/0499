---
- name: AWX Organization Deployment Runbook
  hosts: localhost
  connection: local
  vars_files: 
    - ../vars/awx_vars.yaml
    - ../vars/logo_var.yaml
  collections:
    - ansible.controller
    - awx.awx
  vars:
    filename: tower.filename  
  tasks:
  - name: Create Kubeconfig Credentials Type
    credential_type: 
      name: kubeconfig
      description: Credential to use kube config file
      kind: cloud
      inputs: '{"fields":[{"id":"kubeconfig","type":"string","label":"KubeConfig","help_text":"Paste your KubeConfig"}]}'
      injectors: '{"env":{"K8S_AUTH_KUBECONFIG":"{{ "{{ " }}{{ filename }}{{ " }}" }}"},"file":{"template":"[mykubeconfig]\n{{ "{{ " }}kubeconfig{{ " }}" }}"}}'
      state: present
      validate_certs: false 

  - name: Add Kubeconfig Credentials
    credential:
      name: "openshift.demo.local"
      credential_type: kubeconfig
      organization: "{{ awx.org }}"
      inputs:
        kubeconfig: "{{ lookup('file', lookup('env','K8S_AUTH_KUBECONFIG')) }}"
